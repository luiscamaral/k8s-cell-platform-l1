# ExternalSecret for Karpenter Talos Values
# Pulls Talos cluster join credentials from Vault
#
# Vault path: secret/kubernetes/karpenter/talos-values
# Required keys in Vault:
#   - machineToken: Talos machine token for worker nodes
#   - machineCA: Talos machine CA certificate (PEM)
#   - clusterID: Cluster ID from Talos config
#   - clusterSecret: Cluster secret for joining
#   - bootstrapToken: Bootstrap token for cluster join
#   - clusterEndpoint: Control plane endpoint URL
#   - clusterName: Kubernetes cluster name
#   - talosVersion: Talos version for worker image
#   - kubeletVersion: Kubelet version to use
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: karpenter-talos-values
  namespace: kube-system
  labels:
    app.kubernetes.io/name: karpenter
    app.kubernetes.io/component: talos-values
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: karpenter-talos-values
    template:
      type: Opaque
  data:
    - secretKey: machineToken
      remoteRef:
        key: secret/data/kubernetes/karpenter/talos-values
        property: machineToken
    - secretKey: machineCA
      remoteRef:
        key: secret/data/kubernetes/karpenter/talos-values
        property: machineCA
    - secretKey: clusterID
      remoteRef:
        key: secret/data/kubernetes/karpenter/talos-values
        property: clusterID
    - secretKey: clusterSecret
      remoteRef:
        key: secret/data/kubernetes/karpenter/talos-values
        property: clusterSecret
    - secretKey: bootstrapToken
      remoteRef:
        key: secret/data/kubernetes/karpenter/talos-values
        property: bootstrapToken
    - secretKey: clusterEndpoint
      remoteRef:
        key: secret/data/kubernetes/karpenter/talos-values
        property: clusterEndpoint
    - secretKey: clusterName
      remoteRef:
        key: secret/data/kubernetes/karpenter/talos-values
        property: clusterName
    - secretKey: talosVersion
      remoteRef:
        key: secret/data/kubernetes/karpenter/talos-values
        property: talosVersion
    - secretKey: kubeletVersion
      remoteRef:
        key: secret/data/kubernetes/karpenter/talos-values
        property: kubeletVersion
